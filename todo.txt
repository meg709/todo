# Run this entire block in an elevated PowerShell window (Run as Administrator)

# --- 0. Set the username/hive for clarity ---
$Username = "PublicUser"
$HiveName = "TempPublic"
$UserPath = "C:\Users\$Username\NTUSER.DAT"
$CorrectedEdgePolicyPath = "HKEY_USERS\$HiveName\Software\Policies\Microsoft\Edge" # <-- THE FIX!

# --- 1. Load PublicUser's registry hive ---
Write-Host "1. Loading PublicUser's registry hive..." -ForegroundColor Yellow
# This uses the native Windows 'reg' command and does NOT need the PowerShell prefix
reg load HKU\$HiveName "$UserPath"

# --- 2. Define the base policy path ---
# This path is now corrected to use the absolute HKEY_USERS root that the native reg load command creates under HKU.

# --- 3. Nuke old garbage and create the base Edge key (Ensuring the parent exists first!) ---
Write-Host "2. Nuking old policy garbage and creating base policy key..." -ForegroundColor Yellow
# Safely remove the entire existing structure first (using the corrected path)
Remove-Item "Registry::$CorrectedEdgePolicyPath" -Recurse -Force -ErrorAction SilentlyContinue 

# Explicitly create the base policy key using the corrected path structure
New-Item "Registry::$CorrectedEdgePolicyPath" -Force

# --- 4. Create the URLAllowlist and URLBlocklist subkeys ---
Write-Host "3. Creating URL subkeys..." -ForegroundColor Yellow
New-Item "Registry::$CorrectedEdgePolicyPath\URLAllowlist" -Force
New-Item "Registry::$CorrectedEdgePolicyPath\URLBlocklist" -Force

# --- 5. Allow ONLY the two NYP sites (HTTP + HTTPS + wildcards) ---
Write-Host "4. Setting the Allowlist rules..." -ForegroundColor Yellow
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath\URLAllowlist" -Name 1 -Value "https://library.nyp.edu.sg/*"
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath\URLAllowlist" -Name 2 -Value "https://www.nyp.edu.sg/*"
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath\URLAllowlist" -Name 3 -Value "http://library.nyp.edu.sg/*"
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath\URLAllowlist" -Name 4 -Value "http://www.nyp.edu.sg/*"

# --- 6. Block literally everything else ---
Write-Host "5. Setting the Global Block rule..." -ForegroundColor Yellow
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath\URLBlocklist" -Name 1 -Value "*"

# --- 7. Force the policies to take effect even in weird Edge modes ---
Write-Host "6. Setting Ephemeral Profile policy..." -ForegroundColor Yellow
# Removed the unnecessary '-Type DWord' which caused the second error
Set-ItemProperty "Registry::$CorrectedEdgePolicyPath" -Name "ForceEphemeralProfiles" -Value 0

# --- 8. Unload the hive ---
Write-Host "7. Unloading the registry hive..." -ForegroundColor Yellow
reg unload HKU\$HiveName

Write-Host ""
Write-Host "SUCCESS. The policies should be correctly written now. Log off and back on to test." -ForegroundColor Green
