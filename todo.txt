# Run this entire block in an elevated PowerShell window (Run as Administrator)

# --- 0. Set Variables ---
$Username = "PublicUser"
$HiveName = "TempPublic"
$UserPath = "C:\Users\$Username\NTUSER.DAT"
$HKLMEdgePolicyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"
$HKLMGooglePolicyPath = "HKLM:\SOFTWARE\Policies\Google\Chrome"
$HKUEdgePolicyPath = "HKEY_USERS\$HiveName\Software\Policies\Microsoft\Edge"

# --- 1. Wipe Machine-Wide Edge Policies (Primary target for the 'edge://policy' block) ---
Write-Host "1. Wiping Machine-Wide Edge Policies (HKLM)..." -ForegroundColor Red
Remove-Item $HKLMEdgePolicyPath -Recurse -Force -ErrorAction SilentlyContinue

# --- 2. Wipe Machine-Wide Chrome Policies (Just in case Edge is reading Chrome's policy location) ---
Write-Host "2. Wiping Machine-Wide Chrome Policies (HKLM)..." -ForegroundColor Red
Remove-Item $HKLMGooglePolicyPath -Recurse -Force -ErrorAction SilentlyContinue

# --- 3. Load PublicUser's registry hive ---
Write-Host "3. Loading PublicUser's registry hive..." -ForegroundColor Yellow
reg load HKU\$HiveName "$UserPath"

# --- 4. Wipe PublicUser's Edge Policies (User's specific block list) ---
Write-Host "4. Wiping PublicUser's Edge Policies (HKU)..." -ForegroundColor Red
Remove-Item "Registry::$HKUEdgePolicyPath" -Recurse -Force -ErrorAction SilentlyContinue

# --- 5. Unload the hive ---
Write-Host "5. Unloading the registry hive (Will likely show Access Denied)..." -ForegroundColor Yellow
try {
    reg unload HKU\$HiveName
    Write-Host "Unload successful." -ForegroundColor Green
} catch {
    Write-Host "Unload failed. Ignoring." -ForegroundColor Yellow
}

# --- 6. Force Local Group Policy Update (To clear any cached GPOs) ---
Write-Host "6. Forcing Local Group Policy Update..." -ForegroundColor Yellow
gpupdate /force

Write-Host ""
Write-Host "CRITICAL STEP: RESTART THE PC NOW AND LOG BACK IN AS PUBLICUSER TO TEST." -ForegroundColor Red
