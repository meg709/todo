# ------------ START SCRIPT ------------

# Set the PublicUser username
$username = "PublicUser"

# Path to the user's NTUSER.DAT
$userProfilePath = "C:\Users\$username"
$userHivePath = "$userProfilePath\NTUSER.DAT"

# Temporary hive name
$tempHive = "TempPublicUser"

# Load the user's hive
try {
    reg load "HKU\$tempHive" $userHivePath
    Write-Host "Loaded $username hive as HKU\$tempHive"
} catch {
    Write-Host "ERROR: Could not load user hive. Make sure no processes are running for $username." -ForegroundColor Red
    exit 1
}

# Define Edge policies path
$edgeKeyPath = "HKU:\$tempHive\Software\Policies\Microsoft\Edge"

# Create the key if it doesn't exist
if (-not (Test-Path $edgeKeyPath)) {
    New-Item -Path $edgeKeyPath -Force | Out-Null
}

# Set URLAllowlist (only these 2 sites)
$allowList = @(
    "https://library.nyp.edu.sg",
    "https://www.nyp.edu.sg"
)
Set-ItemProperty -Path $edgeKeyPath -Name "URLAllowlist" -Value $allowList -Type MultiString

# Set URLBlocklist (everything else blocked)
Set-ItemProperty -Path $edgeKeyPath -Name "URLBlocklist" -Value @("*") -Type MultiString

# Optional: disable downloads entirely (3 = Block all)
Set-ItemProperty -Path $edgeKeyPath -Name "DownloadRestrictions" -Value 3 -Type DWord

# Optional: disable InPrivate mode
Set-ItemProperty -Path $edgeKeyPath -Name "InPrivateModeAvailability" -Value 2 -Type DWord

# Optional: block all extensions
Set-ItemProperty -Path $edgeKeyPath -Name "ExtensionInstallBlocklist" -Value @("*") -Type MultiString

# Verify: read back values
Write-Host "---- Written values for HKU\$tempHive\Software\Policies\Microsoft\Edge ----"
Get-ItemProperty -Path $edgeKeyPath | Select-Object URLAllowlist, URLBlocklist, DownloadRestrictions, InPrivateModeAvailability, ExtensionInstallBlocklist | Format-List

# Unload the hive
reg unload "HKU\$tempHive"
Write-Host "Unloaded $username hive"

Write-Host ""
Write-Host "DONE. When $username next logs in and launches Edge, only the 2 NYP websites will be accessible."
Write-Host "------------------------------------------------------------"

# ------------ END SCRIPT ------------
